(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))s(e);new MutationObserver(e=>{for(const n of e)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function o(e){const n={};return e.integrity&&(n.integrity=e.integrity),e.referrerPolicy&&(n.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?n.credentials="include":e.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(e){if(e.ep)return;e.ep=!0;const n=o(e);fetch(e.href,n)}})();const m="modulepreload",y=function(r){return"/inter-final/"+r},b={},p=function(t,o,s){let e=Promise.resolve();if(o&&o.length>0){document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),i=(a==null?void 0:a.nonce)||(a==null?void 0:a.getAttribute("nonce"));e=Promise.allSettled(o.map(c=>{if(c=y(c),c in b)return;b[c]=!0;const l=c.endsWith(".css"),f=l?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${f}`))return;const d=document.createElement("link");if(d.rel=l?"stylesheet":m,l||(d.as="script"),d.crossOrigin="",d.href=c,i&&d.setAttribute("nonce",i),document.head.appendChild(d),l)return new Promise((h,g)=>{d.addEventListener("load",h),d.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${c}`)))})}))}function n(a){const i=new Event("vite:preloadError",{cancelable:!0});if(i.payload=a,window.dispatchEvent(i),!i.defaultPrevented)throw a}return e.then(a=>{for(const i of a||[])i.status==="rejected"&&n(i.reason);return t().catch(n)})};async function w(r){const t="=".repeat((4-r.length%4)%4),o=(r+t).replace(/-/g,"+").replace(/_/g,"/"),s=atob(o),e=new Uint8Array(s.length);for(let n=0;n<s.length;++n)e[n]=s.charCodeAt(n);return e}async function k(r){try{const o=await(await navigator.serviceWorker.ready).pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:await w(r)});console.log("Push subscribed",o);const s=window.AUTH_TOKEN||localStorage.getItem("token");if(!s){console.error("Token tidak ditemukan. Pastikan user sudah login.");return}const e=s.startsWith("Bearer ")?s:`Bearer ${s}`,n=btoa(String.fromCharCode.apply(null,new Uint8Array(o.getKey("p256dh")))),a=btoa(String.fromCharCode.apply(null,new Uint8Array(o.getKey("auth")))),i={endpoint:o.endpoint,keys:{p256dh:n,auth:a}};console.log("Payload dikirim:",i),console.log("Authorization header:",e);const c=await fetch("https://story-api.dicoding.dev/v1/notifications/subscribe",{method:"POST",headers:{"Content-Type":"application/json",Authorization:e},body:JSON.stringify(i)});if(c.ok){const l=await c.json();console.log("Berhasil subscribe:",l)}else{const l=await c.text();console.error("Gagal subscribe:",c.status,c.statusText,l)}return o}catch(t){throw console.error("Failed to subscribe",t),t}}async function v(){try{const t=await(await navigator.serviceWorker.ready).pushManager.getSubscription();if(!t){console.log("No push subscription to unsubscribe.");return}const o=window.AUTH_TOKEN||localStorage.getItem("token")||"";if(!o){console.error("Token tidak ditemukan. Pastikan user sudah login sebelum unsubscribe."),await t.unsubscribe().catch(c=>console.warn("Local unsubscribe error",c));return}const s=o.startsWith("Bearer ")?o:`Bearer ${o}`,e=JSON.stringify({endpoint:t.endpoint}),a=await fetch("https://story-api.dicoding.dev/v1/notifications/unsubscribe",{method:"POST",mode:"cors",headers:{"Content-Type":"application/json",Authorization:s},body:e});if(!a.ok){const c=await a.text().catch(()=>null);console.error("Unsubscribe API gagal:",a.status,a.statusText,c),await t.unsubscribe().catch(l=>console.warn("Local unsubscribe failed after API error",l));return}console.log("Unsubscribe API response:",await a.json().catch(()=>"no-json"));const i=await t.unsubscribe();console.log("Push unsubscribed (client):",i)}catch(r){console.error("Failed to unsubscribe",r);try{const o=await(await navigator.serviceWorker.ready).pushManager.getSubscription();o&&(await o.unsubscribe(),console.log("Push unsubscribed (client, after error)."))}catch(t){console.warn("Failed to cleanup local subscription after error",t)}}}async function P(){try{return!!await(await navigator.serviceWorker.ready).pushManager.getSubscription()}catch{return!1}}const S="storymap-db",A=2;let u;function E(){const r=indexedDB.open(S,A);r.onupgradeneeded=t=>{u=t.target.result,u.objectStoreNames.contains("stories")||u.createObjectStore("stories",{keyPath:"id"}),u.objectStoreNames.contains("pending")||u.createObjectStore("pending",{autoIncrement:!0}),u.objectStoreNames.contains("bookmarks")||u.createObjectStore("bookmarks",{keyPath:"id"})},r.onsuccess=t=>{u=t.target.result,console.log("IDB ready")},r.onerror=t=>{console.error("IDB error",t)}}async function _(r,t){if(!navigator.onLine)return;const o=[],s=u.transaction("pending","readonly").objectStore("pending").openCursor();s.onsuccess=async e=>{const n=e.target.result;if(n)o.push({key:n.key,val:n.value}),n.continue();else for(const a of o)try{const i=new FormData;for(const l in a.val)i.append(l,a.val[l]);await fetch(r+"/stories",{method:"POST",headers:{Authorization:t},body:i}),u.transaction("pending","readwrite").objectStore("pending").delete(a.key)}catch(i){console.warn("sync failed",i)}}}function L(r){return new Promise((t,o)=>{const s=u.transaction("bookmarks","readwrite");s.objectStore("bookmarks").put(r).onsuccess=()=>t(!0),s.onerror=e=>o(e)})}function O(r){return new Promise((t,o)=>{const s=u.transaction("bookmarks","readwrite");s.objectStore("bookmarks").delete(r).onsuccess=()=>t(!0),s.onerror=e=>o(e)})}function B(r){return new Promise((t,o)=>{const e=u.transaction("bookmarks","readonly").objectStore("bookmarks").get(r);e.onsuccess=()=>t(!!e.result),e.onerror=n=>o(n)})}function I(){return new Promise((r,t)=>{const o=[],s=u.transaction("bookmarks","readonly").objectStore("bookmarks").openCursor();s.onsuccess=e=>{const n=e.target.result;n?(o.push(n.value),n.continue()):r(o)},s.onerror=e=>t(e)})}const T="BCCs2eonMI-6H2ctvFaWg-UYdDv387Vno_bzUzALpB442r2lCnsHmtrx8biyPi_E-1fSGABK_Qs_GlvPoJJqxbk";function C(){"serviceWorker"in navigator&&navigator.serviceWorker.register("/inter-final/sw.js").then(e=>{console.log("SW registered",e)}).catch(e=>console.warn("SW registration failed",e));let r;window.addEventListener("beforeinstallprompt",s=>{s.preventDefault(),r=s;const e=document.createElement("button");e.id="install-app-button",e.textContent="Install App",e.style.marginLeft="8px",document.querySelector("header").appendChild(e),e.addEventListener("click",async()=>{e.disabled=!0,r.prompt();const n=await r.userChoice;console.log("Install choice",n),e.remove()})});const t=document.createElement("button");t.id="push-toggle",t.textContent="Enable Push",t.setAttribute("aria-pressed","false"),t.style.marginLeft="8px",t.addEventListener("click",async()=>{if(!("serviceWorker"in navigator)||!("PushManager"in window)){alert("Push notifications are not supported in this browser.");return}await P()?(await v(),t.textContent="Enable Push",t.setAttribute("aria-pressed","false")):(await k(T),t.textContent="Disable Push",t.setAttribute("aria-pressed","true"))});const o=document.querySelector("header");o&&o.appendChild(t),E(),window.addEventListener("online",()=>{_(window.STORY_API_BASE,window.AUTH_TOKEN)})}window.STORY_API_BASE="https://story-api.dicoding.dev/v1";window.addEventListener("DOMContentLoaded",()=>{const r=localStorage.getItem("token"),t=location.hash;!r&&!t.startsWith("#/login")&&!t.startsWith("#/register")&&(location.hash="#/login"),r&&(t.startsWith("#/login")||t.startsWith("#/register"))&&(location.hash="#/"),window.AUTH_TOKEN=r||null,p(async()=>{const{default:o}=await import("./router-BmVQGWpG.js");return{default:o}},[]).then(({default:o})=>{p(async()=>{const{default:s}=await import("./appController-DqZtN_Wq.js");return{default:s}},[]).then(({default:s})=>{const e=document.getElementById("app"),n=new s(e);o(e,n)})})});window.addEventListener("keydown",r=>{(r.key?r.key.toLowerCase():"")==="m"&&!r.metaKey&&!r.ctrlKey&&(location.hash="#/map")});window.addEventListener("load",()=>{try{C()}catch(r){console.warn("PWA init failed",r)}});export{L as b,I as g,B as i,O as u};
