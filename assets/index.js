(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))s(e);new MutationObserver(e=>{for(const o of e)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function n(e){const o={};return e.integrity&&(o.integrity=e.integrity),e.referrerPolicy&&(o.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?o.credentials="include":e.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(e){if(e.ep)return;e.ep=!0;const o=n(e);fetch(e.href,o)}})();const y="modulepreload",m=function(r){return"/inter-final/"+r},p={},h=function(t,n,s){let e=Promise.resolve();if(n&&n.length>0){document.getElementsByTagName("link");const i=document.querySelector("meta[property=csp-nonce]"),a=(i==null?void 0:i.nonce)||(i==null?void 0:i.getAttribute("nonce"));e=Promise.allSettled(n.map(l=>{if(l=m(l),l in p)return;p[l]=!0;const u=l.endsWith(".css"),f=u?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${f}`))return;const d=document.createElement("link");if(d.rel=u?"stylesheet":y,u||(d.as="script"),d.crossOrigin="",d.href=l,a&&d.setAttribute("nonce",a),document.head.appendChild(d),u)return new Promise((b,g)=>{d.addEventListener("load",b),d.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${l}`)))})}))}function o(i){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=i,window.dispatchEvent(a),!a.defaultPrevented)throw i}return e.then(i=>{for(const a of i||[])a.status==="rejected"&&o(a.reason);return t().catch(o)})};async function w(r){const t="=".repeat((4-r.length%4)%4),n=(r+t).replace(/-/g,"+").replace(/_/g,"/"),s=atob(n),e=new Uint8Array(s.length);for(let o=0;o<s.length;++o)e[o]=s.charCodeAt(o);return e}async function k(r){try{const n=await(await navigator.serviceWorker.ready).pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:await w(r)});console.log("Push subscribed",n);const s=n.getKey("p256dh"),e=btoa(String.fromCharCode(...new Uint8Array(s))),o=n.getKey("auth"),i=btoa(String.fromCharCode(...new Uint8Array(o))),a={endpoint:n.endpoint,keys:{p256dh:e,auth:i}},l=window.AUTH_TOKEN||localStorage.getItem("token");console.log("Payload dikirim:",a);const u=await fetch("https://story-api.dicoding.dev/v1/notifications/subscribe",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l}`},body:JSON.stringify(a)});if(u.ok)console.log("Berhasil subscribe");else{const f=await u.text();console.error("Server response:",f)}return n}catch(t){throw console.error("Failed to subscribe",t),t}}async function v(){try{const t=await(await navigator.serviceWorker.ready).pushManager.getSubscription();t&&(await fetch(window.STORY_API_BASE+"/notifications/unsubscribe",{method:"POST",headers:{"Content-Type":"application/json",Authorization:window.AUTH_TOKEN},body:JSON.stringify({endpoint:t.endpoint})}).catch(()=>{}),await t.unsubscribe(),console.log("Push unsubscribed"))}catch(r){console.error("Failed to unsubscribe",r)}}async function S(){try{return!!await(await navigator.serviceWorker.ready).pushManager.getSubscription()}catch{return!1}}const P="storymap-db",A=2;let c;function E(){const r=indexedDB.open(P,A);r.onupgradeneeded=t=>{c=t.target.result,c.objectStoreNames.contains("stories")||c.createObjectStore("stories",{keyPath:"id"}),c.objectStoreNames.contains("pending")||c.createObjectStore("pending",{autoIncrement:!0}),c.objectStoreNames.contains("bookmarks")||c.createObjectStore("bookmarks",{keyPath:"id"})},r.onsuccess=t=>{c=t.target.result,console.log("IDB ready")},r.onerror=t=>{console.error("IDB error",t)}}async function _(r,t){if(!navigator.onLine)return;const n=[],s=c.transaction("pending","readonly").objectStore("pending").openCursor();s.onsuccess=async e=>{const o=e.target.result;if(o)n.push({key:o.key,val:o.value}),o.continue();else for(const i of n)try{const a=new FormData;for(const u in i.val)a.append(u,i.val[u]);await fetch(r+"/stories",{method:"POST",headers:{Authorization:t},body:a}),c.transaction("pending","readwrite").objectStore("pending").delete(i.key)}catch(a){console.warn("sync failed",a)}}}function L(r){return new Promise((t,n)=>{const s=c.transaction("bookmarks","readwrite");s.objectStore("bookmarks").put(r).onsuccess=()=>t(!0),s.onerror=e=>n(e)})}function T(r){return new Promise((t,n)=>{const s=c.transaction("bookmarks","readwrite");s.objectStore("bookmarks").delete(r).onsuccess=()=>t(!0),s.onerror=e=>n(e)})}function B(r){return new Promise((t,n)=>{const e=c.transaction("bookmarks","readonly").objectStore("bookmarks").get(r);e.onsuccess=()=>t(!!e.result),e.onerror=o=>n(o)})}function I(){return new Promise((r,t)=>{const n=[],s=c.transaction("bookmarks","readonly").objectStore("bookmarks").openCursor();s.onsuccess=e=>{const o=e.target.result;o?(n.push(o.value),o.continue()):r(n)},s.onerror=e=>t(e)})}const O="BCCs2eonMI-6H2ctvFaWg-UYdDv387Vno_bzUzALpB442r2lCnsHmtrx8biyPi_E-1fSGABK_Qs_GlvPoJJqxbk";function C(){"serviceWorker"in navigator&&navigator.serviceWorker.register("/inter-final/sw.js").then(e=>{console.log("SW registered",e)}).catch(e=>console.warn("SW registration failed",e));let r;window.addEventListener("beforeinstallprompt",s=>{s.preventDefault(),r=s;const e=document.createElement("button");e.id="install-app-button",e.textContent="Install App",e.style.marginLeft="8px",document.querySelector("header").appendChild(e),e.addEventListener("click",async()=>{e.disabled=!0,r.prompt();const o=await r.userChoice;console.log("Install choice",o),e.remove()})});const t=document.createElement("button");t.id="push-toggle",t.textContent="Enable Push",t.setAttribute("aria-pressed","false"),t.style.marginLeft="8px",t.addEventListener("click",async()=>{if(!("serviceWorker"in navigator)||!("PushManager"in window)){alert("Push notifications are not supported in this browser.");return}await S()?(await v(),t.textContent="Enable Push",t.setAttribute("aria-pressed","false")):(await k(O),t.textContent="Disable Push",t.setAttribute("aria-pressed","true"))});const n=document.querySelector("header");n&&n.appendChild(t),E(),window.addEventListener("online",()=>{_(window.STORY_API_BASE,window.AUTH_TOKEN)})}window.STORY_API_BASE="https://story-api.dicoding.dev/v1";window.addEventListener("DOMContentLoaded",()=>{const r=localStorage.getItem("token"),t=location.hash;!r&&!t.startsWith("#/login")&&!t.startsWith("#/register")&&(location.hash="#/login"),r&&(t.startsWith("#/login")||t.startsWith("#/register"))&&(location.hash="#/"),window.AUTH_TOKEN=r||null,h(async()=>{const{default:n}=await import("./router-BmVQGWpG.js");return{default:n}},[]).then(({default:n})=>{h(async()=>{const{default:s}=await import("./appController-DqZtN_Wq.js");return{default:s}},[]).then(({default:s})=>{const e=document.getElementById("app"),o=new s(e);n(e,o)})})});window.addEventListener("keydown",r=>{(r.key?r.key.toLowerCase():"")==="m"&&!r.metaKey&&!r.ctrlKey&&(location.hash="#/map")});window.addEventListener("load",()=>{try{C()}catch(r){console.warn("PWA init failed",r)}});export{L as b,I as g,B as i,T as u};
