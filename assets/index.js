(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))s(t);new MutationObserver(t=>{for(const n of t)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function o(t){const n={};return t.integrity&&(n.integrity=t.integrity),t.referrerPolicy&&(n.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?n.credentials="include":t.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(t){if(t.ep)return;t.ep=!0;const n=o(t);fetch(t.href,n)}})();const y="modulepreload",m=function(r){return"/inter-final/"+r},h={},f=function(e,o,s){let t=Promise.resolve();if(o&&o.length>0){document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),i=(a==null?void 0:a.nonce)||(a==null?void 0:a.getAttribute("nonce"));t=Promise.allSettled(o.map(c=>{if(c=m(c),c in h)return;h[c]=!0;const l=c.endsWith(".css"),b=l?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${b}`))return;const d=document.createElement("link");if(d.rel=l?"stylesheet":y,l||(d.as="script"),d.crossOrigin="",d.href=c,i&&d.setAttribute("nonce",i),document.head.appendChild(d),l)return new Promise((p,g)=>{d.addEventListener("load",p),d.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${c}`)))})}))}function n(a){const i=new Event("vite:preloadError",{cancelable:!0});if(i.payload=a,window.dispatchEvent(i),!i.defaultPrevented)throw a}return t.then(a=>{for(const i of a||[])i.status==="rejected"&&n(i.reason);return e().catch(n)})};async function w(r){const e="=".repeat((4-r.length%4)%4),o=(r+e).replace(/-/g,"+").replace(/_/g,"/"),s=atob(o),t=new Uint8Array(s.length);for(let n=0;n<s.length;++n)t[n]=s.charCodeAt(n);return t}async function k(r){try{const o=await(await navigator.serviceWorker.ready).pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:await w(r)});console.log("Push subscribed",o);const s=o.getKey("p256dh"),t=btoa(String.fromCharCode(...new Uint8Array(s))),n=o.getKey("auth"),a=btoa(String.fromCharCode(...new Uint8Array(n))),i={endpoint:o.endpoint,keys:{p256dh:t,auth:a}},c=window.AUTH_TOKEN||localStorage.getItem("token"),l=c.startsWith("Bearer ")?c:`Bearer ${c}`;console.log("Payload dikirim:",i),console.log("Authorization header:",l);const b=await fetch("https://story-api.dicoding.dev/v1/notifications/subscribe",{method:"POST",headers:{"Content-Type":"application/json",Authorization:l},body:JSON.stringify(i)});if(b.ok)console.log("Berhasil subscribe");else{const d=await b.text();console.error("Server response:",d)}return o}catch(e){throw console.error("Failed to subscribe",e),e}}async function v(){try{const e=await(await navigator.serviceWorker.ready).pushManager.getSubscription();if(!e){console.log("No push subscription to unsubscribe.");return}const o=window.AUTH_TOKEN||localStorage.getItem("token")||"";if(!o){console.error("Token tidak ditemukan. Pastikan user sudah login sebelum unsubscribe."),await e.unsubscribe().catch(c=>console.warn("Local unsubscribe error",c));return}const s=o.startsWith("Bearer ")?o:`Bearer ${o}`,t=JSON.stringify({endpoint:e.endpoint}),a=await fetch("https://story-api.dicoding.dev/v1/notifications/unsubscribe",{method:"POST",mode:"cors",headers:{"Content-Type":"application/json",Authorization:s},body:t});if(!a.ok){const c=await a.text().catch(()=>null);console.error("Unsubscribe API gagal:",a.status,a.statusText,c),await e.unsubscribe().catch(l=>console.warn("Local unsubscribe failed after API error",l));return}console.log("Unsubscribe API response:",await a.json().catch(()=>"no-json"));const i=await e.unsubscribe();console.log("Push unsubscribed (client):",i)}catch(r){console.error("Failed to unsubscribe",r);try{const o=await(await navigator.serviceWorker.ready).pushManager.getSubscription();o&&(await o.unsubscribe(),console.log("Push unsubscribed (client, after error)."))}catch(e){console.warn("Failed to cleanup local subscription after error",e)}}}async function P(){try{return!!await(await navigator.serviceWorker.ready).pushManager.getSubscription()}catch{return!1}}const S="storymap-db",A=2;let u;function E(){const r=indexedDB.open(S,A);r.onupgradeneeded=e=>{u=e.target.result,u.objectStoreNames.contains("stories")||u.createObjectStore("stories",{keyPath:"id"}),u.objectStoreNames.contains("pending")||u.createObjectStore("pending",{autoIncrement:!0}),u.objectStoreNames.contains("bookmarks")||u.createObjectStore("bookmarks",{keyPath:"id"})},r.onsuccess=e=>{u=e.target.result,console.log("IDB ready")},r.onerror=e=>{console.error("IDB error",e)}}async function _(r,e){if(!navigator.onLine)return;const o=[],s=u.transaction("pending","readonly").objectStore("pending").openCursor();s.onsuccess=async t=>{const n=t.target.result;if(n)o.push({key:n.key,val:n.value}),n.continue();else for(const a of o)try{const i=new FormData;for(const l in a.val)i.append(l,a.val[l]);await fetch(r+"/stories",{method:"POST",headers:{Authorization:e},body:i}),u.transaction("pending","readwrite").objectStore("pending").delete(a.key)}catch(i){console.warn("sync failed",i)}}}function O(r){return new Promise((e,o)=>{const s=u.transaction("bookmarks","readwrite");s.objectStore("bookmarks").put(r).onsuccess=()=>e(!0),s.onerror=t=>o(t)})}function T(r){return new Promise((e,o)=>{const s=u.transaction("bookmarks","readwrite");s.objectStore("bookmarks").delete(r).onsuccess=()=>e(!0),s.onerror=t=>o(t)})}function B(r){return new Promise((e,o)=>{const t=u.transaction("bookmarks","readonly").objectStore("bookmarks").get(r);t.onsuccess=()=>e(!!t.result),t.onerror=n=>o(n)})}function I(){return new Promise((r,e)=>{const o=[],s=u.transaction("bookmarks","readonly").objectStore("bookmarks").openCursor();s.onsuccess=t=>{const n=t.target.result;n?(o.push(n.value),n.continue()):r(o)},s.onerror=t=>e(t)})}const C="BCCs2eonMI-6H2ctvFaWg-UYdDv387Vno_bzUzALpB442r2lCnsHmtrx8biyPi_E-1fSGABK_Qs_GlvPoJJqxbk";function L(){"serviceWorker"in navigator&&navigator.serviceWorker.register("/inter-final/sw.js").then(t=>{console.log("SW registered",t)}).catch(t=>console.warn("SW registration failed",t));let r;window.addEventListener("beforeinstallprompt",s=>{s.preventDefault(),r=s;const t=document.createElement("button");t.id="install-app-button",t.textContent="Install App",t.style.marginLeft="8px",document.querySelector("header").appendChild(t),t.addEventListener("click",async()=>{t.disabled=!0,r.prompt();const n=await r.userChoice;console.log("Install choice",n),t.remove()})});const e=document.createElement("button");e.id="push-toggle",e.textContent="Enable Push",e.setAttribute("aria-pressed","false"),e.style.marginLeft="8px",e.addEventListener("click",async()=>{if(!("serviceWorker"in navigator)||!("PushManager"in window)){alert("Push notifications are not supported in this browser.");return}await P()?(await v(),e.textContent="Enable Push",e.setAttribute("aria-pressed","false")):(await k(C),e.textContent="Disable Push",e.setAttribute("aria-pressed","true"))});const o=document.querySelector("header");o&&o.appendChild(e),E(),window.addEventListener("online",()=>{_(window.STORY_API_BASE,window.AUTH_TOKEN)})}window.STORY_API_BASE="https://story-api.dicoding.dev/v1";window.addEventListener("DOMContentLoaded",()=>{const r=localStorage.getItem("token"),e=location.hash;!r&&!e.startsWith("#/login")&&!e.startsWith("#/register")&&(location.hash="#/login"),r&&(e.startsWith("#/login")||e.startsWith("#/register"))&&(location.hash="#/"),window.AUTH_TOKEN=r||null,f(async()=>{const{default:o}=await import("./router-BmVQGWpG.js");return{default:o}},[]).then(({default:o})=>{f(async()=>{const{default:s}=await import("./appController-DqZtN_Wq.js");return{default:s}},[]).then(({default:s})=>{const t=document.getElementById("app"),n=new s(t);o(t,n)})})});window.addEventListener("keydown",r=>{(r.key?r.key.toLowerCase():"")==="m"&&!r.metaKey&&!r.ctrlKey&&(location.hash="#/map")});window.addEventListener("load",()=>{try{L()}catch(r){console.warn("PWA init failed",r)}});export{O as b,I as g,B as i,T as u};
