(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))s(e);new MutationObserver(e=>{for(const o of e)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function n(e){const o={};return e.integrity&&(o.integrity=e.integrity),e.referrerPolicy&&(o.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?o.credentials="include":e.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(e){if(e.ep)return;e.ep=!0;const o=n(e);fetch(e.href,o)}})();const y="modulepreload",m=function(r){return"/inter-final/"+r},f={},p=function(t,n,s){let e=Promise.resolve();if(n&&n.length>0){document.getElementsByTagName("link");const i=document.querySelector("meta[property=csp-nonce]"),a=(i==null?void 0:i.nonce)||(i==null?void 0:i.getAttribute("nonce"));e=Promise.allSettled(n.map(c=>{if(c=m(c),c in f)return;f[c]=!0;const u=c.endsWith(".css"),b=u?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${b}`))return;const d=document.createElement("link");if(d.rel=u?"stylesheet":y,u||(d.as="script"),d.crossOrigin="",d.href=c,a&&d.setAttribute("nonce",a),document.head.appendChild(d),u)return new Promise((h,g)=>{d.addEventListener("load",h),d.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${c}`)))})}))}function o(i){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=i,window.dispatchEvent(a),!a.defaultPrevented)throw i}return e.then(i=>{for(const a of i||[])a.status==="rejected"&&o(a.reason);return t().catch(o)})};async function w(r){const t="=".repeat((4-r.length%4)%4),n=(r+t).replace(/-/g,"+").replace(/_/g,"/"),s=atob(n),e=new Uint8Array(s.length);for(let o=0;o<s.length;++o)e[o]=s.charCodeAt(o);return e}async function k(r){try{const n=await(await navigator.serviceWorker.ready).pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:await w(r)});console.log("Push subscribed",n);const s=window.AUTH_TOKEN||localStorage.getItem("token");if(!s){console.error("Token tidak ditemukan. Pastikan user sudah login.");return}const e=s.startsWith("Bearer ")?s:`Bearer ${s}`,o=n.getKey("p256dh"),i=n.getKey("auth");if(!o||!i){console.error("Kunci subscription tidak valid:",o,i);return}const a={endpoint:n.endpoint,keys:{p256dh:btoa(String.fromCharCode(...new Uint8Array(o))),auth:btoa(String.fromCharCode(...new Uint8Array(i)))}};console.log("Payload final sebelum dikirim:",JSON.stringify(a,null,2)),console.log("Authorization header:",e);const c=await fetch("https://story-api.dicoding.dev/v1/notifications/subscribe",{method:"POST",headers:{"Content-Type":"application/json",Authorization:e},body:JSON.stringify(a)}),u=await c.text();return console.log("Server response:",u,"status:",c.status),c.ok?console.log("Berhasil subscribe!"):console.error("Gagal subscribe:",c.status,c.statusText,u),n}catch(t){throw console.error("Failed to subscribe",t),t}}async function v(){try{const t=await(await navigator.serviceWorker.ready).pushManager.getSubscription();if(!t){console.log("No push subscription to unsubscribe.");return}const n=window.AUTH_TOKEN||localStorage.getItem("token")||"",s=n.startsWith("Bearer ")?n:`Bearer ${n}`,e=JSON.stringify({subscription:JSON.stringify({endpoint:t.endpoint})}),o="https://story-api.dicoding.dev/v1/notifications/unsubscribe";try{const i=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json",Authorization:s},body:e});if(i.ok)console.log("Unsubscribe API sukses:",await i.text());else{const a=await i.text();console.warn("Unsubscribe API gagal (mungkin CORS):",i.status,a)}}catch{console.warn("Unsubscribe gagal karena CORS, lanjut unsubscribe lokal.")}await t.unsubscribe(),console.log("Push unsubscribed (client).")}catch(r){console.error("Failed to unsubscribe",r)}}async function S(){try{return!!await(await navigator.serviceWorker.ready).pushManager.getSubscription()}catch{return!1}}const P="storymap-db",A=2;let l;function E(){const r=indexedDB.open(P,A);r.onupgradeneeded=t=>{l=t.target.result,l.objectStoreNames.contains("stories")||l.createObjectStore("stories",{keyPath:"id"}),l.objectStoreNames.contains("pending")||l.createObjectStore("pending",{autoIncrement:!0}),l.objectStoreNames.contains("bookmarks")||l.createObjectStore("bookmarks",{keyPath:"id"})},r.onsuccess=t=>{l=t.target.result,console.log("IDB ready")},r.onerror=t=>{console.error("IDB error",t)}}async function O(r,t){if(!navigator.onLine)return;const n=[],s=l.transaction("pending","readonly").objectStore("pending").openCursor();s.onsuccess=async e=>{const o=e.target.result;if(o)n.push({key:o.key,val:o.value}),o.continue();else for(const i of n)try{const a=new FormData;for(const u in i.val)a.append(u,i.val[u]);await fetch(r+"/stories",{method:"POST",headers:{Authorization:t},body:a}),l.transaction("pending","readwrite").objectStore("pending").delete(i.key)}catch(a){console.warn("sync failed",a)}}}function T(r){return new Promise((t,n)=>{const s=l.transaction("bookmarks","readwrite");s.objectStore("bookmarks").put(r).onsuccess=()=>t(!0),s.onerror=e=>n(e)})}function L(r){return new Promise((t,n)=>{const s=l.transaction("bookmarks","readwrite");s.objectStore("bookmarks").delete(r).onsuccess=()=>t(!0),s.onerror=e=>n(e)})}function B(r){return new Promise((t,n)=>{const e=l.transaction("bookmarks","readonly").objectStore("bookmarks").get(r);e.onsuccess=()=>t(!!e.result),e.onerror=o=>n(o)})}function I(){return new Promise((r,t)=>{const n=[],s=l.transaction("bookmarks","readonly").objectStore("bookmarks").openCursor();s.onsuccess=e=>{const o=e.target.result;o?(n.push(o.value),o.continue()):r(n)},s.onerror=e=>t(e)})}const C="BCCs2eonMI-6H2ctvFaWg-UYdDv387Vno_bzUzALpB442r2lCnsHmtrx8biyPi_E-1fSGABK_Qs_GlvPoJJqxbk";function _(){"serviceWorker"in navigator&&navigator.serviceWorker.register("/inter-final/sw.js").then(e=>{console.log("SW registered",e)}).catch(e=>console.warn("SW registration failed",e));let r;window.addEventListener("beforeinstallprompt",s=>{s.preventDefault(),r=s;const e=document.createElement("button");e.id="install-app-button",e.textContent="Install App",e.style.marginLeft="8px",document.querySelector("header").appendChild(e),e.addEventListener("click",async()=>{e.disabled=!0,r.prompt();const o=await r.userChoice;console.log("Install choice",o),e.remove()})});const t=document.createElement("button");t.id="push-toggle",t.textContent="Enable Push",t.setAttribute("aria-pressed","false"),t.style.marginLeft="8px",t.addEventListener("click",async()=>{if(!("serviceWorker"in navigator)||!("PushManager"in window)){alert("Push notifications are not supported in this browser.");return}await S()?(await v(),t.textContent="Enable Push",t.setAttribute("aria-pressed","false")):(await k(C),t.textContent="Disable Push",t.setAttribute("aria-pressed","true"))});const n=document.querySelector("header");n&&n.appendChild(t),E(),window.addEventListener("online",()=>{O(window.STORY_API_BASE,window.AUTH_TOKEN)})}window.STORY_API_BASE="https://story-api.dicoding.dev/v1";window.addEventListener("DOMContentLoaded",()=>{const r=localStorage.getItem("token"),t=location.hash;!r&&!t.startsWith("#/login")&&!t.startsWith("#/register")&&(location.hash="#/login"),r&&(t.startsWith("#/login")||t.startsWith("#/register"))&&(location.hash="#/"),window.AUTH_TOKEN=r||null,p(async()=>{const{default:n}=await import("./router-BmVQGWpG.js");return{default:n}},[]).then(({default:n})=>{p(async()=>{const{default:s}=await import("./appController-DqZtN_Wq.js");return{default:s}},[]).then(({default:s})=>{const e=document.getElementById("app"),o=new s(e);n(e,o)})})});window.addEventListener("keydown",r=>{(r.key?r.key.toLowerCase():"")==="m"&&!r.metaKey&&!r.ctrlKey&&(location.hash="#/map")});window.addEventListener("load",()=>{try{_()}catch(r){console.warn("PWA init failed",r)}});export{T as b,I as g,B as i,L as u};
